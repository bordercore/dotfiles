# Master .prompt file for setting the BASH prompt
#  by F. Jerrell Schivers
#  based on work by KrON from windowmaker on IRC and Spidey 08/06

function set_prompt {

    EXITSTATUS="$?"

    if [ "$TERM" == "dumb" ]; then
	return
    fi

    # For a lighter version of any of these colors,
    #  replace the '0' with '1', eg turn green to
    #  light green 0;32m => 1;32m

    local OFF="\[\033[m\]"
    local BOLD="\[\033[1m\]"
    local black="\[\033[0;30m\]"
    local red="\[\033[0;31m\]"
    local yellow="\[\033[0;33m\]"
    local green="\[\033[0;32m\]"
    local cyan="\[\033[1;36m\]"
    local white="\[\033[37m\]"
    local blue="\[\033[34m\]"
    local purple="\[\033[35m\]"
    local brown="\[\033[33m\]"
    local grad=`tty|cut -d/ -f3`

    local bakred='\e[41m'   # Red Background

    ERROR=

    # If the last command resulted in an error, prominently display the exit status
    if [ "$EXITSTATUS" -ne "0" ]; then
	ERROR=" $BOLD$bakred$EXITSTATUS$OFF"
    fi

    # Capture the number of jobs
    JOBS=`jobs | wc -l | awk '{print $1}'`

    if [ $JOBS -ne 0 ]; then
	if [ $JOBS -eq 1 ]; then
	    JOBS=" $green($BOLD${red}1 job$OFF)"
	else
	    JOBS=" $green($BOLD$red$JOBS jobs$OFF)"
	fi
    else
	JOBS=""
    fi

    # Are we running in a screen?
    [ "$STY" != "" ] && SFLAG='-SCR' || SFLAG=''

    # Set SSH_FLAG only if this is a remote (ssh) connection.  This will be used in the prompt
    local SSH_IP=`echo $SSH_CLIENT | awk '{ print $1 }'`
    if [ $SSH_IP ]; then
	local SSH_FLAG="$red@$yellow\h"
    fi

    # When displaying the PWD in the prompt, we want to truncate it so avoid displaying excessively long paths
    MAXLENGTH=100
    MYPWD=`echo $PWD | sed "s@$HOME@~@g"`  # If we're in our home dir, then use ~ for $HOME
    LENGTH=${#MYPWD}

    if [ $(( LENGTH )) -gt $MAXLENGTH ] ; then
	MYPWD=${MYPWD:$LENGTH-$MAXLENGTH:$MAXLENGTH}
	MYPWD="...$MYPWD"
    fi

    export PS1="$purple┌ $red\$(date +%l:%M%P\ %m/%d) $green$MYPWD\n$purple└ $brown\u$SSH_FLAG$green$JOBS$SFLAG$ERROR$yellow $purple-> $off"

    export P2="> "

}

PROMPT_COMMAND=set_prompt


# Colors:
#
# \[\033[31m\]  --  yellow
# \[\033[32m\]  --  green
# \[\033[33m\]  --  red
# \[\033[34m\]  --  blue
# \[\033[35m\]  --  purple
# \[\033[36m\]  --  cyan
# \[\033[37m\]  --  white
#
# Attributes:
#
# Bold -- 1;  (eg \[\033[1;31m\] for bold red)
#
# Special Characters:
#
# \304  --  (long dash)
# \371  --  (centered dot, large)
# \372  --  (centered dot, small)
# \332  --  (upper-left-hand corner piece)
# \300  --  (lower-left-hand corner piece)
